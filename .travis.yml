sudo: true
dist: trusty
language: cpp

# regex is for release tags
branches:
  only:
    - master
    - /^v(\d+\.){2}\d+$/

matrix:
  include:
    - os: linux
      env: JOB=verify-commit-format ENV=linux
    - os: linux
      env: JOB=test ENV=linux
    - os: linux 
      env: build-docs DOXYGEN_CONFIG_FILE=doxygen.conf
    - os: linux
      env: JOB=deploy ENV=linux
    - os: linux
      env: JOB=deploy ENV=windows ARCH=i686 LIBTYPE=shared
      services:
        - docker
    - os: linux
      env: JOB=deploy ENV=windows ARCH=x86_64 LIBTYPE=shared
      services:
        - docker
    - os: osx
      env: JOB=deploy ENV=osx

deploy:
  provider: releases
  api_key:
  secure: "BRbzTWRvadALRQSTihMKruOj64ydxusMUS9FQR//qFlS345ZYfYta43W//4LcWWDKtj6IvA6DRqNdabgWnpbpxpnm9gVftGUdOKlU3niPZhwsMkB2M12QHUnAP6DVOfGPvdciBV+6mu73SSxniEcrYjZ1CrRX7mknmehPpVKxNk="
  file: "./qTox.dmg"
  on:
    condition: $TRAVIS_OS_NAME == osx
    repo: qTox/qTox
    tags: true
  skip_cleanup: true

after_success:
  ->
  test $TRAVIS_PULL_REQUEST == "false"
  && test $TRAVIS_BRANCH == "master"
  && test $JOB == "build-docs"
  && bash ./.travis/deploy-docs.sh

install:      .travis/phase $JOB $ENV install
script:       .travis/phase $JOB $ENV script
after_script: .travis/phase $JOB $ENV after_script
