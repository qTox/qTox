sudo: required
dist: trusty
language: cpp
cache: ccache

# regex is for release tags
branches:
  only:
    - master
    - /^v(\d+\.){2}\d+$/

matrix:
  fast_finish: true
  include:
    - os: linux
      env: JOB=verify-commit-format
    - os: linux
      env: JOB=build-docs DOXYGEN_CONFIG_FILE=doxygen.conf
    - os: linux
      env: JOB=build-gitstats GITSTATS_DIR=gitstats
      addons:
        apt:
          packages:
            - gitstats
    # the actual compilin'
    - os: linux
      env: JOB=build-ubuntu-14-04
      addons:
        apt:
          sources:
            # for ffmpeg
            - sourceline: 'ppa:mc3man/trusty-media'
            - sourceline: 'ppa:chris-lea/libsodium'
            # need to test against Qt 5.3
            - sourceline: 'ppa:beineri/opt-qt532-trusty'
          packages:
            - automake
            - build-essential
            - check
            - checkinstall
            - ffmpeg
            - libgdk-pixbuf2.0-dev
            - libglib2.0-dev
            - libgtk2.0-dev
            - libopenal-dev
            - libopus-dev
            - libqrencode-dev
            - libsodium-dev
            - libsqlcipher-dev
            - libswscale-dev
            - libtool
            - libvpx-dev
            - libxss-dev qrencode
            - qt53base
            - qt53script
            - qt53svg
            - qt53tools
            - qt53xmlpatterns
            - qttools5-dev
            - qttools5-dev-tools
            - pkg-config
    - os: osx
      osx_image: xcode7.3
      env: JOB=build-osx

script: "./.travis/$JOB.sh"

deploy:
  # osx binary
  provider: releases
  api_key:
    secure: "BRbzTWRvadALRQSTihMKruOj64ydxusMUS9FQR//qFlS345ZYfYta43W//4LcWWDKtj6IvA6DRqNdabgWnpbpxpnm9gVftGUdOKlU3niPZhwsMkB2M12QHUnAP6DVOfGPvdciBV+6mu73SSxniEcrYjZ1CrRX7mknmehPpVKxNk="
  file: "./qTox.dmg"
  on:
    condition: $TRAVIS_OS_NAME == osx
    repo: qTox/qTox
    tags: true
  skip_cleanup: true

  # branch for windows jenkins build
  provider: script
  script: .travis/deploy-jenkins-branch.sh
  on:
    tags: true
  skip_cleanup: true


after_success:
  - >
    test $TRAVIS_PULL_REQUEST == "false"
    && test $TRAVIS_BRANCH == "master"
    && test $JOB == "build-docs"
    && bash ./.travis/deploy-docs.sh
  - >
    test $TRAVIS_PULL_REQUEST == "false"
    && test $TRAVIS_BRANCH == "master"
    && test $JOB == "build-gitstats"
    && bash ./.travis/deploy-gitstats.sh
