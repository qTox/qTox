---
version: 2.1
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name : Export environment variables
          command: |
            echo 'export MAKEFLAGS="j4"' >> $BASH_ENV
            echo 'export BUILD__="x86_64"' >> $BASH_ENV
            echo 'export BTYPE__="release"' >> $BASH_ENV
            docker info
      - run:
          name: Install zip
          command: |
            sudo apt-get update
            sudo apt-get install zip
      - restore_cache:
          key: dependency-cache
          paths:
            - ~/cache
      - run:
          name: Build stage 1
          command: |
            ./.travis/build-windows.sh "$BUILD__" "$BTYPE__" "~/cache/${BUILD__}" stage1
      - run:
          name: Build stage 2
          command: |
            ./.travis/build-windows.sh "$BUILD__" "$BTYPE__" "~/cache/${BUILD__}" stage2
            ls -al ~/cache
      - save_cache:
          key: dependency-cache
          paths:
            - ~/cache
      - run:
          name: Build stage 3
          command: |
            ./.travis/build-windows.sh "$BUILD__" "$BTYPE__" "~/cache/${BUILD__}" stage3
      - run:
          name: Debug info
          command: |
            ls -al ~/
            ls -al "{CIRCLE_WORKING_DIRECTORY}/workspace/${BUILD__}/qtox/${BTYPE__}/"
            ls -al "{CIRCLE_WORKING_DIRECTORY}/workspace/${BUILD__}/qtox/${BTYPE__}/qtox.exe"
      - run:
          name: Zip artifacts
          command: |
            cd "{CIRCLE_WORKING_DIRECTORY}/workspace/${BUILD__}/qtox/${BTYPE__}/"
            zip -r "qtox_${BUILD__}_${BTYPE__}.zip" *
      - store_artifacts:
          path: "${CIRCLE_WORKING_DIRECTORY}/workspace/${BUILD__}/qtox/${BTYPE__}/qtox.exe"
      - store_artifacts:
          path: "${CIRCLE_WORKING_DIRECTORY}/workspace/${BUILD__}/qtox/${BTYPE__}/qtox_${BUILD__}_${BTYPE__}.zip"
workflows:
  version: 2
  build:
    jobs:
      - build
