---
version: 2.1
jobs:
  build:
    machine: true
    steps:
      - run:
          name : Export env
          command: |
            echo 'export MAKEFLAGS="j4"' >> $BASH_ENV
            echo 'export BUILD__="x86_64"' >> $BASH_ENV
            echo 'export BTYPE__="release"' >> $BASH_ENV
      - run:
          name: Install zip
          command: |
            sudo apt-get update
            sudo apt-get install zip
      - run:
          name: Build stage 1
          command: |
            docker info
            ./.travis/build-windows.sh "$BUILD__" "$BTYPE__" ~/cache/"$BUILD__" stage1
      - run:
          name: Build stage 2
          command: |
            ./.travis/build-windows.sh "$BUILD__" "$BTYPE__" ~/cache/"$BUILD__" stage2
            ls -al ~/cache
      - run:
          name: Build stage 3
          command: |
            ./.travis/build-windows.sh "$BUILD__" "$BTYPE__" ~/cache/"$BUILD__" stage3
            ls -al ~/
            ls -al ~/qTox/workspace/"$BUILD__"/qtox/"$BTYPE__"/
            ls -al ~/qTox/workspace/"$BUILD__"/qtox/"$BTYPE__"/qtox.exe
      - run:
          name: Zip artifacts
          command: |
            cd ~/qTox/workspace/"$BUILD__"/qtox/"$BTYPE__"/
            zip -r qtox_"$BUILD__"_"$BTYPE__".zip *
      - store_artifacts:
          path: ~/qTox/workspace/"$BUILD__"/qtox/"$BTYPE__"/qtox.exe
      - store_artifacts:
          path: ~/qTox/workspace/"$BUILD__"/qtox/"$BTYPE__"/qtox_"$BUILD__"_"$BTYPE__".zip
workflows:
  version: 2
  build:
    jobs:
      - build
